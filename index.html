<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  
  <!-- 1. ç¶²ç«™æ¨™é¡Œèˆ‡ Meta (é‚„åŸæ‚¨åŸæœ¬çš„è¨­å®š) -->
  <title>å¤§é˜ªç•¢æ¥­æ—…è¡Œå°å¹«æ‰‹</title>
  <meta name="description" content="è‡ªå‹•åŒ¯ç‡æ›ç®—ã€å¤šäººåˆ†å¸³ï¼Œå¤§é˜ªç•¢æ¥­æ—…è¡Œå¿…å‚™è¨˜å¸³å·¥å…·ï¼">

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="å¤§é˜ªé’æ˜¥ç•¢æ—… - è¨˜å¸³åˆ†å¸³å°å¹«æ‰‹">
  <meta property="og:description" content="è‡ªå‹•åŒ¯ç‡æ›ç®—ã€å¤šäººåˆ†å¸³ï¼Œè¼•é¬†æå®šç•¢æ¥­æ—…è¡Œå¸³å‹™ï¼">
  <meta property="og:image" content="https://placehold.co/1200x630/ec4899/ffffff.png?text=OSAKA+TRIP&font=montserrat">
  <meta property="og:url" content="https://johnnyfu987.github.io/osaka-trip/">
  
  <!-- PWA è¨­å®š -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#ec4899">
  <link rel="apple-touch-icon" href="https://placehold.co/180x180/ec4899/ffffff.png?text=Osaka&font=roboto">
  <link rel="icon" type="image/png" href="https://placehold.co/192x192/ec4899/ffffff.png?text=Osaka&font=roboto">

  <!-- å¥—ä»¶å¼•å…¥ -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- Leaflet åœ°åœ– -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700&family=Noto+Sans+TC:wght@400;500;700&display=swap');
    
    body { 
      font-family: 'M PLUS Rounded 1c', 'Noto Sans TC', sans-serif; 
      background: linear-gradient(135deg, #fff1f2 0%, #e0f2fe 100%);
      min-height: 100vh;
      -webkit-tap-highlight-color: transparent; 
      color: #475569;
      padding-bottom: 80px; /* é¿å…å…§å®¹è¢«åº•éƒ¨é®ä½ */
    }
    ::-webkit-scrollbar { width: 0px; background: transparent; }
    
    /* === æ‚¨çš„è¨­è¨ˆé‚„åŸï¼šè¼‰å…¥å‹•ç•« === */
    .loading-overlay { 
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(255,255,255,0.8); backdrop-filter: blur(5px);
      display: flex; justify-content: center; align-items: center; z-index: 999; flex-direction: column; 
    }

    /* === æ‚¨çš„è¨­è¨ˆé‚„åŸï¼šç»ç’ƒæ“¬æ…‹å¡ç‰‡ === */
    .glass-card {
      background: rgba(255, 255, 255, 0.95); border: 1px solid rgba(255, 255, 255, 0.5);
      box-shadow: 0 4px 15px rgba(244, 114, 182, 0.15); backdrop-filter: blur(10px);
    }
    
    .pop-btn { transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
    .pop-btn:active { transform: scale(0.95); }

    /* === æ‚¨çš„è¨­è¨ˆé‚„åŸï¼šToggle Switch === */
    .toggle-checkbox:checked { right: 0; border-color: #f472b6; }
    .toggle-checkbox:checked + .toggle-label { background-color: #f472b6; }

    /* å°èˆªæŒ‰éˆ•æ¨£å¼å„ªåŒ– */
    .nav-item {
        color: #94a3b8; transition: all 0.3s;
    }
    .nav-item.active {
        color: #ec4899; transform: scale(1.1); font-weight: bold;
    }
    
    /* åœ°åœ–æ¨£å¼ */
    #map { height: 60vh; width: 100%; border-radius: 1.5rem; box-shadow: 0 4px 20px rgba(0,0,0,0.1); z-index: 0; }
  </style>
</head>

<body>
  <div id="app" class="max-w-md mx-auto min-h-screen relative">
    
    <!-- 1. é‚„åŸçš„ Loading ç•«é¢ -->
    <div v-if="loading" class="loading-overlay">
      <div class="relative">
         <i class="fas fa-plane fa-bounce text-5xl text-pink-400 mb-4 drop-shadow-lg"></i>
         <i class="fas fa-cloud text-blue-200 absolute -top-2 -right-6 text-2xl animate-pulse"></i>
      </div>
      <span class="text-pink-500 font-bold text-lg tracking-widest mt-2">OSAKA TRIP</span>
      <span class="text-gray-400 text-xs">{{ loadingMessage }}</span>
      <button v-if="showRetryBtn" @click="loadAllData" class="mt-4 px-4 py-1 bg-gray-100 rounded-full text-xs text-gray-500">é‡è©¦</button>
    </div>

    <!-- 2. é‚„åŸçš„ Header (ç™½è‰²éœ§é¢è³ªæ„Ÿ) -->
    <div class="sticky top-0 bg-white/90 backdrop-blur-md shadow-sm z-40 pt-10 pb-2 px-5 rounded-b-3xl">
      <h1 class="text-2xl font-bold text-gray-800 flex justify-center items-center gap-2 mb-3">
        <span class="text-pink-500"><i class="fas fa-torii-gate"></i></span>
        <span>å¤§é˜ªç•¢æ¥­æ—…è¡Œ</span>
        <span class="text-blue-400"><i class="fas fa-paper-plane text-sm"></i></span>
      </h1>
      
      <!-- åŠŸèƒ½å°èˆªåˆ— (æ•´åˆäº†æ–°åŠŸèƒ½) -->
      <div class="bg-gray-100/80 p-1.5 rounded-2xl flex justify-between shadow-inner overflow-x-auto no-scrollbar">
        <button v-for="tab in tabs" :key="tab.id" 
          @click="switchTab(tab.id)"
          :class="currentTab === tab.id ? 'bg-white text-pink-500 shadow-md' : 'text-gray-400 hover:text-gray-600'"
          class="flex-1 py-2 rounded-xl text-xs font-bold transition-all flex flex-col items-center justify-center gap-1 min-w-[60px]">
          <i :class="tab.icon + ' text-base'"></i>
          <span>{{ tab.name }}</span>
        </button>
      </div>

      <!-- å¦‚æœæ˜¯è¡Œç¨‹é ï¼Œé¡¯ç¤ºæ—¥æœŸé¸æ“‡ -->
      <div v-if="currentTab === 'itinerary'" class="mt-3 flex gap-2 overflow-x-auto pb-2 no-scrollbar">
        <button v-for="(day, idx) in tripDays" :key="day" 
          @click="selectedDate = day"
          class="flex-shrink-0 px-3 py-1.5 rounded-full text-xs font-bold transition-all border"
          :class="selectedDate === day ? 'bg-pink-500 text-white border-pink-500 shadow-md' : 'bg-white text-gray-500 border-gray-200'">
          12/{{ day.split('-')[2] }} (D{{idx+1}})
        </button>
      </div>
    </div>

    <!-- 3. ä¸»è¦å…§å®¹å€ -->
    <div class="p-5 space-y-6">
      
      <!-- (A) è¡Œç¨‹è¡¨ (å„ªåŒ–ç‰ˆ) -->
      <div v-show="currentTab === 'itinerary'">
        <div class="flex justify-between items-center mb-4">
           <h2 class="font-bold text-gray-700">ç•¶æ—¥è¡Œç¨‹</h2>
           <button @click="openItineraryModal()" class="text-xs bg-pink-100 text-pink-500 px-3 py-1.5 rounded-full font-bold hover:bg-pink-200 transition">
             <i class="fas fa-plus mr-1"></i>æ–°å¢
           </button>
        </div>

        <div v-if="filteredItinerary.length === 0" class="text-center py-10">
           <div class="w-20 h-20 bg-gray-100 rounded-full mx-auto flex items-center justify-center text-gray-300 text-2xl mb-2"><i class="fas fa-bed"></i></div>
           <p class="text-gray-400 text-sm">é€™å¤©é‚„æ²’æœ‰å®‰æ’è¡Œç¨‹å–”</p>
        </div>

        <div class="space-y-4 relative pl-4">
          <!-- æ™‚é–“è»¸ç·š -->
          <div class="absolute left-[21px] top-2 bottom-4 w-0.5 bg-gray-200 -z-10"></div>
          
          <div v-for="item in filteredItinerary" :key="item.id" class="relative pl-8 group">
            <!-- æ™‚é–“é»é» -->
            <div class="absolute left-0 top-3 w-3 h-3 rounded-full bg-white border-2 border-pink-400 z-10"></div>
            
            <!-- è¡Œç¨‹å¡ç‰‡ -->
            <div @click="openItineraryModal(item)" class="glass-card p-4 rounded-2xl cursor-pointer active:scale-95 transition hover:shadow-lg bg-white relative overflow-hidden">
               <!-- å·¦å´æ™‚é–“ -->
               <div class="flex items-start gap-3">
                 <div class="flex flex-col items-center min-w-[50px]">
                   <span class="text-lg font-bold text-gray-800">{{ item.starttime }}</span>
                   <span v-if="item.endtime" class="text-[10px] text-gray-400">{{ item.endtime }}</span>
                 </div>
                 <!-- å³å´å…§å®¹ -->
                 <div class="flex-1 border-l pl-3 border-gray-100">
                   <div class="flex justify-between items-start">
                     <h3 class="font-bold text-gray-700 text-base mb-1">{{ item.title }}</h3>
                     <span class="text-[10px] px-2 py-0.5 rounded-full" 
                       :class="getCategoryClass(item.type)">{{ item.type_label }}</span>
                   </div>
                   <div v-if="item.location" class="text-xs text-gray-500 flex items-center gap-1 mb-1">
                     <i class="fas fa-map-marker-alt text-pink-400"></i> {{ item.location }}
                   </div>
                   <div v-if="item.note" class="text-xs text-gray-400 bg-gray-50 p-2 rounded-lg mt-1">
                     <i class="fas fa-sticky-note mr-1 text-yellow-400"></i>{{ item.note }}
                   </div>
                 </div>
               </div>
               <!-- åˆªé™¤æŒ‰éˆ• -->
               <button @click.stop="deleteItinerary(item.id)" class="absolute top-2 right-2 text-gray-200 hover:text-red-400 p-2"><i class="fas fa-trash-alt"></i></button>
            </div>
          </div>
        </div>
      </div>

      <!-- (B) åœ°åœ– (æ›´æ›ç‚ºå¥½çœ‹çš„åº•åœ–) -->
      <div v-show="currentTab === 'map'">
        <div class="glass-card p-1 rounded-[1.5rem]">
          <div id="map"></div>
        </div>
        <div class="mt-4 flex gap-2 overflow-x-auto pb-2 no-scrollbar">
           <!-- å¿«é€Ÿå®šä½è¡Œç¨‹æŒ‰éˆ• -->
           <button v-for="item in filteredItinerary" :key="item.id" @click="panTo(item.lat, item.lng)" 
             v-show="item.lat && item.lng"
             class="bg-white px-3 py-2 rounded-xl text-xs font-bold shadow-sm whitespace-nowrap border border-gray-100 text-gray-600">
             ğŸ“ {{ item.title }}
           </button>
        </div>
        <button @click="locateUser" class="w-full mt-2 bg-blue-500 text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-200">
          <i class="fas fa-location-arrow mr-2"></i>å®šä½æˆ‘çš„ä½ç½®
        </button>
      </div>

      <!-- (C) è¨˜å¸³ (é‚„åŸæ‚¨ç†Ÿæ‚‰çš„ä»‹é¢) -->
      <div v-show="currentTab === 'record'">
         <div class="glass-card p-5 rounded-3xl mb-4 relative overflow-hidden">
            <div class="absolute -right-5 -top-5 w-24 h-24 bg-pink-100 rounded-full opacity-50"></div>
            <p class="text-xs text-gray-400 font-bold uppercase mb-1">Total Expenses</p>
            <div class="flex items-baseline gap-2">
              <span class="text-3xl font-bold text-gray-800 font-mono">NT$ {{ Math.round(totalExpense).toLocaleString() }}</span>
            </div>
         </div>

         <!-- æ–°å¢æŒ‰éˆ•å€ -->
         <button @click="openExpenseModal" class="w-full bg-gray-800 text-white py-4 rounded-2xl font-bold shadow-xl shadow-gray-300 flex justify-center items-center gap-2 mb-6 pop-btn">
           <span>è¨˜ä¸€ç­†</span> <i class="fas fa-pen"></i>
         </button>

         <!-- åˆ—è¡¨ -->
         <div class="space-y-3 pb-10">
           <div v-for="exp in expenses" :key="exp.rowId" class="bg-white p-4 rounded-xl shadow-sm border border-gray-50 flex justify-between items-center">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-pink-50 text-pink-500 flex items-center justify-center font-bold text-xs">
                  {{ exp.date ? exp.date.substring(5) : '-' }}
                </div>
                <div>
                  <div class="font-bold text-gray-700 text-sm">{{ exp.item }}</div>
                  <div class="text-[10px] text-gray-400">{{ exp.payer }} ä»˜æ¬¾</div>
                </div>
              </div>
              <div class="text-right">
                <div class="font-bold text-gray-800 font-mono">{{ Number(exp.amount).toLocaleString() }}</div>
                <button @click="deleteExpense(exp.rowId)" class="text-gray-300 hover:text-red-400 text-xs p-1"><i class="fas fa-trash"></i></button>
              </div>
           </div>
         </div>
      </div>

      <!-- (D) çµç®— (é‚„åŸè¨­è¨ˆ) -->
      <div v-show="currentTab === 'settlement'" class="space-y-4">
         <div class="bg-gradient-to-br from-pink-500 to-rose-400 text-white p-6 rounded-[2rem] shadow-xl shadow-pink-200">
            <div class="text-center">
               <div class="text-pink-100 text-sm font-bold opacity-80">ç¸½èŠ±è²»</div>
               <div class="text-4xl font-bold font-mono mt-1">NT$ {{ Math.round(totalExpense).toLocaleString() }}</div>
            </div>
         </div>
         
         <div class="bg-white rounded-3xl p-5 shadow-sm border border-gray-100">
            <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2"><i class="fas fa-exchange-alt text-blue-400"></i> å»ºè­°è½‰å¸³</h3>
            <div v-if="settlements.length === 0" class="text-center py-6 text-green-500 font-bold text-sm">å¸³å‹™å·²å¹³è¡¡ ğŸ‰</div>
            <div class="space-y-3">
               <div v-for="s in settlements" class="flex justify-between items-center p-3 bg-gray-50 rounded-xl">
                  <div class="flex items-center gap-2">
                     <span class="font-bold text-gray-600">{{ s.from }}</span>
                     <i class="fas fa-arrow-right text-gray-300 text-xs"></i>
                     <span class="font-bold text-gray-600">{{ s.to }}</span>
                  </div>
                  <span class="font-bold text-pink-500 font-mono">NT$ {{ s.amount.toLocaleString() }}</span>
               </div>
            </div>
         </div>
      </div>

      <!-- (E) è³¼ç‰©æ¸…å–® (äººæ€§åŒ–åˆ†é ç‰ˆ) -->
      <div v-show="currentTab === 'shopping'" class="space-y-4">
         <!-- äººå“¡ç¯©é¸ Tab -->
         <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
            <button @click="shoppingFilter = 'all'" :class="shoppingFilter === 'all' ? 'bg-purple-500 text-white' : 'bg-white text-gray-500'" class="px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap shadow-sm transition-colors">å…¨éƒ¨</button>
            <button v-for="u in users" :key="u.name" @click="shoppingFilter = u.name" 
              :class="shoppingFilter === u.name ? 'bg-purple-500 text-white' : 'bg-white text-gray-500'"
              class="px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap shadow-sm transition-colors">{{ u.name }}</button>
         </div>

         <div class="flex justify-end">
            <button @click="openShoppingModal" class="bg-purple-50 text-purple-600 px-4 py-2 rounded-xl text-xs font-bold hover:bg-purple-100 transition"><i class="fas fa-plus mr-1"></i> æ–°å¢é¡˜æœ›</button>
         </div>

         <div class="grid grid-cols-2 gap-3 pb-20">
            <div v-for="item in filteredShoppingList" :key="item.id" class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 relative group overflow-hidden">
               <div class="flex justify-between items-start mb-2">
                  <div class="text-[10px] bg-gray-100 text-gray-500 px-2 py-0.5 rounded-md">{{ item.owner }}</div>
                  <button @click="deleteShopping(item.id)" class="text-gray-200 hover:text-red-400"><i class="fas fa-times"></i></button>
               </div>
               <h3 class="font-bold text-gray-800 text-sm mb-1 line-clamp-2" :class="{'line-through text-gray-300': item.isbought}">{{ item.item }}</h3>
               <div class="text-xs font-mono text-purple-500 font-bold">Â¥{{ Number(item.estprice).toLocaleString() }}</div>
               
               <!-- è²·åˆ°äº†æŒ‰éˆ• -->
               <button @click="toggleBought(item)" class="w-full mt-3 py-1.5 rounded-lg text-xs font-bold transition-colors flex items-center justify-center gap-1"
                 :class="item.isbought ? 'bg-green-100 text-green-600' : 'bg-gray-50 text-gray-400 hover:bg-purple-50 hover:text-purple-500'">
                 <i class="fas" :class="item.isbought ? 'fa-check-circle' : 'fa-circle'"></i> {{ item.isbought ? 'å·²è³¼è²·' : 'æ¨™è¨˜è³¼è²·' }}
               </button>
            </div>
         </div>
      </div>

    </div>

    <!-- Modals (å½ˆå‡ºè¦–çª—) -->
    <div v-if="modal.show" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/50 backdrop-blur-sm p-4" @click.self="modal.show = false">
      <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-[slideUp_0.3s_ease-out]">
        <h3 class="text-lg font-bold mb-4 text-gray-800 flex items-center gap-2">
          <span class="w-1 h-6 bg-pink-500 rounded-full"></span> {{ modal.title }}
        </h3>

        <!-- 1. è¡Œç¨‹è¡¨å–® -->
        <div v-if="modal.type === 'itinerary'" class="space-y-3">
           <input v-model="formItinerary.title" placeholder="è¡Œç¨‹æ¨™é¡Œ (å¦‚: ç’°çƒå½±åŸ)" class="w-full bg-gray-50 p-3 rounded-xl text-sm outline-none font-bold focus:ring-2 ring-pink-100">
           <div class="flex gap-2">
             <select v-model="formItinerary.type" class="bg-gray-50 p-3 rounded-xl text-sm outline-none w-1/3">
               <option value="spot">æ™¯é»</option><option value="food">ç¾é£Ÿ</option><option value="shopping">è³¼ç‰©</option><option value="transport">äº¤é€š</option>
             </select>
             <input type="time" v-model="formItinerary.starttime" class="bg-gray-50 p-3 rounded-xl text-sm outline-none flex-1 text-center">
             <span class="py-3 text-gray-300">-</span>
             <input type="time" v-model="formItinerary.endtime" class="bg-gray-50 p-3 rounded-xl text-sm outline-none flex-1 text-center">
           </div>
           <input v-model="formItinerary.location" placeholder="åœ°é»åç¨± (ç”¨æ–¼åœ°åœ–)" class="w-full bg-gray-50 p-3 rounded-xl text-sm outline-none">
           <textarea v-model="formItinerary.note" placeholder="å‚™è¨» (é¸å¡«)" rows="2" class="w-full bg-gray-50 p-3 rounded-xl text-sm outline-none"></textarea>
           
           <div class="flex gap-2 pt-2">
             <button @click="modal.show = false" class="flex-1 bg-gray-100 text-gray-500 py-3 rounded-xl font-bold text-sm">å–æ¶ˆ</button>
             <button @click="submitItinerary" class="flex-1 bg-pink-500 text-white py-3 rounded-xl font-bold text-sm shadow-lg shadow-pink-200">å„²å­˜</button>
           </div>
        </div>

        <!-- 2. è¨˜å¸³è¡¨å–® -->
        <div v-if="modal.type === 'expense'" class="space-y-3">
           <input v-model="formExpense.item" placeholder="æ¶ˆè²»é …ç›®" class="w-full bg-gray-50 p-3 rounded-xl text-sm outline-none font-bold">
           <div class="relative">
             <span class="absolute left-4 top-3 text-gray-400 text-sm font-bold">NT$</span>
             <input type="number" v-model="formExpense.amount" placeholder="0" class="w-full bg-gray-50 p-3 pl-12 rounded-xl text-xl font-mono font-bold outline-none text-gray-800">
           </div>
           
           <div class="flex gap-2 items-center overflow-x-auto pb-1 no-scrollbar">
             <span class="text-xs text-gray-400 whitespace-nowrap">ä»˜æ¬¾:</span>
             <button v-for="u in users" @click="formExpense.payer = u.name"
               :class="formExpense.payer === u.name ? 'bg-gray-800 text-white' : 'bg-gray-100 text-gray-500'"
               class="px-3 py-1.5 rounded-full text-xs font-bold transition whitespace-nowrap">{{ u.name }}</button>
           </div>

           <div class="bg-gray-50 p-3 rounded-xl">
             <div class="flex justify-between items-center mb-2">
               <span class="text-xs text-gray-400">åˆ†å¸³å°è±¡</span>
               <button @click="toggleAllExpBen" class="text-[10px] text-blue-500 font-bold">å…¨é¸/å…¨æ¶ˆ</button>
             </div>
             <div class="flex flex-wrap gap-2">
               <button v-for="u in users" @click="toggleExpBen(u.name)" 
                 :class="formExpense.beneficiaries.includes(u.name) ? 'bg-pink-500 text-white shadow-md' : 'bg-white text-gray-400 border border-gray-200'"
                 class="px-3 py-1.5 rounded-full text-xs font-bold transition">{{ u.name }}</button>
             </div>
           </div>
           <button @click="submitExpense" class="w-full bg-gray-900 text-white py-3 rounded-xl font-bold mt-2 shadow-lg">ç¢ºèªè¨˜å¸³</button>
        </div>

        <!-- 3. è³¼ç‰©è¡¨å–® -->
        <div v-if="modal.type === 'shopping'" class="space-y-3">
           <input v-model="formShopping.item" placeholder="æƒ³è²·ä»€éº¼?" class="w-full bg-gray-50 p-3 rounded-xl text-sm outline-none font-bold">
           <div class="flex gap-2">
             <input type="number" v-model="formShopping.estprice" placeholder="é ç®—(æ—¥å¹£)" class="flex-1 bg-gray-50 p-3 rounded-xl text-sm outline-none">
             <select v-model="formShopping.owner" class="flex-1 bg-gray-50 p-3 rounded-xl text-sm outline-none">
                <option v-for="u in users" :value="u.name">{{u.name}}</option>
             </select>
           </div>
           <button @click="submitShopping" class="w-full bg-purple-500 text-white py-3 rounded-xl font-bold mt-2 shadow-lg shadow-purple-200">åŠ å…¥æ¸…å–®</button>
        </div>

      </div>
    </div>

  </div>

  <!-- é‚è¼¯è…³æœ¬ -->
  <script>
    const { createApp, ref, reactive, computed, onMounted, watch, nextTick } = Vue;
    // æ‚¨çš„ API ç¶²å€ (ç¶­æŒä¸è®Š)
    const API_URL = "https://script.google.com/macros/s/AKfycbzD0COm2xYm2aqt8-Xap6og3XWPOnPp3P4YsKYFbRofWAUUOFswPtRJUYCp7NLPLW_tAA/exec";

    createApp({
      setup() {
        const currentTab = ref('itinerary');
        const loading = ref(false);
        const loadingMessage = ref('è¼‰å…¥ä¸­...');
        const showRetryBtn = ref(false);
        
        // æ—¥æœŸè¨­å®šï¼š2025/12/17 - 12/22
        const selectedDate = ref('2025-12-17');
        const tripDays = ['2025-12-17', '2025-12-18', '2025-12-19', '2025-12-20', '2025-12-21', '2025-12-22'];
        
        const tabs = [
          {id: 'itinerary', name: 'è¡Œç¨‹', icon: 'fas fa-calendar-alt'},
          {id: 'map', name: 'åœ°åœ–', icon: 'fas fa-map'},
          {id: 'record', name: 'è¨˜å¸³', icon: 'fas fa-pen'},
          {id: 'settlement', name: 'çµç®—', icon: 'fas fa-calculator'},
          {id: 'shopping', name: 'è³¼ç‰©', icon: 'fas fa-shopping-bag'}
        ];

        const itinerary = ref([]);
        const expenses = ref([]);
        const shoppingList = ref([]);
        const users = ref([]);
        const shoppingFilter = ref('all');
        
        // å€‹äººé é¢ç”¨
        const myIdentity = ref(localStorage.getItem('myIdentity') || '');
        const paidMap = ref({});
        const shouldPayMap = ref({});
        const settlements = ref([]);

        const modal = reactive({ show: false, type: '', title: '' });
        const formItinerary = reactive({});
        const formShopping = reactive({});
        const formExpense = reactive({ payer: '', beneficiaries: [], amount: '' });

        let map = null;

        // --- Core ---
        const runGAS = async (op, argsOrData = null) => {
          try {
            loading.value = true;
            showRetryBtn.value = false;
            const payload = { op };
            // åˆ¤æ–·èˆŠç‰ˆ/æ–°ç‰ˆåƒæ•¸
            if (['addExpense', 'editExpense', 'deleteExpense', 'updateUserPhoto'].includes(op)) {
               payload.args = Array.isArray(argsOrData) ? argsOrData : [argsOrData];
            } else {
               payload.data = argsOrData;
            }
            const res = await fetch(API_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'text/plain;charset=utf-8' },
              body: JSON.stringify(payload)
            });
            return await res.json();
          } catch (e) {
            console.error(e);
            loadingMessage.value = "é€£ç·šå¤±æ•—";
            showRetryBtn.value = true;
            return { success: false };
          } finally {
            loading.value = false;
          }
        };

        const loadAllData = async () => {
          loading.value = true;
          try {
            const res = await fetch(`${API_URL}?op=getAllData`).then(r => r.json());
            if (res) {
              expenses.value = (res.expenses || []).reverse();
              users.value = res.users || [];
              itinerary.value = res.itinerary || [];
              shoppingList.value = res.shopping || [];
              
              if (users.value.length > 0) {
                if(!formExpense.payer) formExpense.payer = users.value[0].name;
                if(!formShopping.owner) formShopping.owner = users.value[0].name;
                // Default select all for expense
                if(formExpense.beneficiaries.length === 0) formExpense.beneficiaries = users.value.map(u => u.name);
              }
              calculateSettlement();
            }
          } catch(e) { console.error(e); showRetryBtn.value = true; } 
          finally { loading.value = false; }
        };

        // --- Computed ---
        const filteredItinerary = computed(() => {
          return itinerary.value.filter(i => i.date === selectedDate.value).sort((a,b) => a.starttime.localeCompare(b.starttime));
        });
        const totalExpense = computed(() => expenses.value.reduce((sum, e) => sum + Number(e.amount), 0));
        const filteredShoppingList = computed(() => {
          if (shoppingFilter.value === 'all') return shoppingList.value;
          return shoppingList.value.filter(i => i.owner === shoppingFilter.value);
        });
        const myExpenses = computed(() => !myIdentity.value ? [] : expenses.value.filter(e => e.beneficiaries.includes(myIdentity.value)));
        const myInfo = computed(() => users.value.find(u => u.name === myIdentity.value));

        // --- Utils ---
        const formatMonthDay = (d) => { const date = new Date(d); return `${date.getMonth()+1}/${date.getDate()}`; };
        
        // --- Shopping ---
        const openShoppingModal = () => {
          modal.type = 'shopping'; modal.title = 'æ–°å¢è³¼ç‰©æ¸…å–®'; modal.show = true;
          Object.assign(formShopping, { item: '', estprice: '', owner: formShopping.owner || '' });
        };
        const submitShopping = async () => {
          const res = await runGAS('addShopping', formShopping);
          if(res.success) { modal.show = false; loadAllData(); }
        };
        const toggleBought = async (item) => {
          item.isbought = !item.isbought;
          await runGAS('toggleShopping', { id: item.id, isBought: item.isbought });
        };
        const deleteShopping = async (id) => {
          if(!confirm('åˆªé™¤?')) return;
          const res = await runGAS('deleteShopping', { id });
          if(res.success) loadAllData();
        };

        // --- Expense ---
        const openExpenseModal = () => {
          modal.type = 'expense'; modal.title = 'æ–°å¢æ¶ˆè²»'; modal.show = true;
          Object.assign(formExpense, { item: '', amount: '' }); // Reset amount/item, keep payer/ben
        };
        const toggleExpBen = (name) => {
          const i = formExpense.beneficiaries.indexOf(name);
          if(i===-1) formExpense.beneficiaries.push(name); else formExpense.beneficiaries.splice(i,1);
        };
        const toggleAllExpBen = () => {
          formExpense.beneficiaries = formExpense.beneficiaries.length === users.value.length ? [] : users.value.map(u=>u.name);
        };
        const submitExpense = async () => {
          // å‚³é€ç¬¦åˆèˆŠç‰ˆæ ¼å¼
          const payload = {
            date: new Date(),
            payer: formExpense.payer,
            beneficiaries: formExpense.beneficiaries,
            item: formExpense.item,
            unitPrice: formExpense.amount,
            quantity: 1,
            note: ''
          };
          const res = await runGAS('addExpense', payload);
          if(res.success) { modal.show = false; loadAllData(); }
        };
        const deleteExpense = async (rowId) => {
          if(!confirm('åˆªé™¤?')) return;
          await runGAS('deleteExpense', rowId);
          loadAllData();
        };

        // --- Itinerary ---
        const openItineraryModal = (item = null) => {
          modal.type = 'itinerary'; modal.title = item ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹'; modal.show = true;
          if(item) Object.assign(formItinerary, item);
          else Object.assign(formItinerary, { id: '', date: selectedDate.value, type: 'spot', starttime: '', endtime: '', title: '', location: '', note: '' });
        };
        const submitItinerary = async () => {
          const res = await runGAS('addItinerary', formItinerary);
          if(res.success) { modal.show = false; loadAllData(); }
        };
        const deleteItinerary = async (id) => {
          if(!confirm('åˆªé™¤?')) return;
          const res = await runGAS('deleteItinerary', { id });
          if(res.success) loadAllData();
        };
        const getCategoryClass = (t) => ({transport:'bg-blue-100 text-blue-600', food:'bg-orange-100 text-orange-600', shopping:'bg-purple-100 text-purple-600', spot:'bg-pink-100 text-pink-600'}[t] || 'bg-gray-100 text-gray-500');

        // --- Settlement Logic (From your code) ---
        const calculateSettlement = () => {
           let paid={}, should={}, total=0;
           users.value.forEach(u => { paid[u.name]=0; should[u.name]=0; });
           expenses.value.forEach(ex => {
             total += ex.amount;
             if(paid[ex.payer]!==undefined) paid[ex.payer] += ex.amount;
             const len = ex.beneficiaries.length;
             if(len>0) { const split = ex.amount/len; ex.beneficiaries.forEach(b => { if(should[b]!==undefined) should[b]+=split; }); }
           });
           paidMap.value = paid; shouldPayMap.value = should;
           let bals = users.value.map(u => ({name: u.name, amt: paid[u.name]-should[u.name]})).filter(x=>Math.abs(x.amt)>1);
           bals.sort((a,b)=>a.amt-b.amt);
           let res=[]; let i=0, j=bals.length-1;
           while(i<j) {
             let d=bals[i], c=bals[j], amt=Math.min(Math.abs(d.amt), c.amt);
             res.push({from:d.name, to:c.name, amount:Math.round(amt)});
             d.amt+=amt; c.amt-=amt; if(Math.abs(d.amt)<1) i++; if(c.amt<1) j--;
           }
           settlements.value = res;
        };

        // --- Map ---
        const locateUser = () => {
          if(map) {
             map.locate({setView: true, maxZoom: 16});
             map.on('locationfound', e => {
               L.marker(e.latlng).addTo(map).bindPopup("ä½ åœ¨é€™è£¡").openPopup();
             });
          }
        };
        const panTo = (lat, lng) => {
           if(map) {
             map.flyTo([lat, lng], 16);
             L.popup().setLatLng([lat, lng]).setContent("ğŸ“ ç›®æ¨™ä½ç½®").openOn(map);
           }
        };
        
        watch(currentTab, (v) => {
          if(v === 'map') {
            nextTick(() => {
              if(!map) {
                // ä½¿ç”¨ CartoDB Voyager é¢¨æ ¼ (æ›´ç°¡æ½”å¥½çœ‹)
                map = L.map('map').setView([34.6937, 135.5022], 13);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
                }).addTo(map);
              }
              map.invalidateSize();
              // æ¸…é™¤èˆŠæ¨™è¨˜
              map.eachLayer((layer) => { if(layer instanceof L.Marker) map.removeLayer(layer); });
              // æ–°å¢è¡Œç¨‹æ¨™è¨˜
              filteredItinerary.value.forEach(i => {
                if(i.lat && i.lng) L.marker([i.lat, i.lng]).addTo(map).bindPopup(i.title);
              });
            });
          }
        });

        onMounted(loadAllData);

        return {
          currentTab, switchTab: (t) => currentTab.value = t,
          loading, loadingMessage, showRetryBtn, loadAllData,
          tripDays, selectedDate, formatMonthDay, tabs,
          expenses, users, shoppingList, shoppingFilter, filteredShoppingList, filteredItinerary,
          totalExpense, modal, formItinerary, formShopping, formExpense,
          openItineraryModal, submitItinerary, deleteItinerary, getCategoryClass,
          openShoppingModal, submitShopping, toggleBought, deleteShopping,
          openExpenseModal, submitExpense, deleteExpense, toggleExpBen, toggleAllExpBen,
          locateUser, panTo, settlements, paidMap, shouldPayMap, myIdentity
        };
      }
    }).mount('#app');
  </script>
</body>
</html>
